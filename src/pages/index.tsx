import Sidebar from "@/components/Sidebar";
import { getConversations } from "@/db/conversations/utils";
import { GetServerSideProps } from "next";
import Head from "next/head";
import { redirect } from "next/navigation";
import { useRouter } from "next/router";
import nookies from "nookies";
import { useEffect } from "react";
import { useAuthState } from "react-firebase-hooks/auth";
import { auth } from "../../config/firebase";
import { Conversation } from "../../models";

type Props = {
  conversations: Conversation[];
};

export default function Home({ conversations }: Props) {
  // redirect('/login');

  const [loggedInUser, loading, _error] = useAuthState(auth);
  const router = useRouter();

  useEffect(() => {
    return () => {
      !loggedInUser && router.push("/login");
    };
  });

  return (
    <>
      <Head>
        <title>Chat App</title>
        <meta name="description" content="Generated by Hiep Tran" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <div>
        {!loggedInUser ? (
          <div></div>
        ) : (
          <Sidebar conversations={conversations} />
        )}
      </div>
    </>
  );
}

export const getServerSideProps: GetServerSideProps<Props> = async (ctx) => {
  const cookies = nookies.get(ctx);

  const conversations = await getConversations(cookies.userEmail);
  console.log("conversations", conversations);

  return {
    props: {
      conversations,
    },
  };
};
